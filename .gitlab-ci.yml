variables:
  TIMEOUT: 3600 # Set default timeout to 3600 seconds

.setup-buildtest: &setup-buildtest
  - export COLUMNS=160
  - export NERSC_HOST=$(cat /etc/clustername)
  - module load python/3.9-anaconda-2021.11
  - python -m venv $CI_PROJECT_DIR/pyenv
  - source $CI_PROJECT_DIR/pyenv/bin/activate
  - git clone -b devel https://github.com/buildtesters/buildtest
  - cd buildtest
  - . setup.sh
  - git log --oneline -1
  - buildtest --help
  - export BUILDTEST_CONFIGFILE=$CI_PROJECT_DIR/config.yml
  - buildtest config validate

.buildspec_cache: &buildspec_cache
  - buildtest buildspec find --quiet --rebuild --root $CI_PROJECT_DIR/buildspecs
  - buildtest buildspec summary
  - buildtest buildspec find invalid

.post_run: &post_run
  - mkdir -p $CI_PROJECT_DIR/.artifacts
  - buildtest report --fail | tee $CI_PROJECT_DIR/.artifacts/report.txt
  - buildtest cdash upload $CDASH_BUILD_NAME
  - cp $(buildtest --logpath) $CI_PROJECT_DIR/.artifacts/

stages:
  - check
  - test

.validate_buildspecs:
  stage: check
  allow_failure: true
  #rules:
  #  - if: '$CI_PIPELINE_SOURCE == "external_pull_request_event" && $CI_EXTERNAL_PULL_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH'
  before_script:
    - *setup-buildtest
  script:
    - *buildspec_cache

.test_compilers:
  stage: check
  allow_failure: true
  #rules:
  #  - if: '$CI_PIPELINE_SOURCE == "external_pull_request_event" && $CI_EXTERNAL_PULL_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH'
  before_script:
    - *setup-buildtest
  script:
    - buildtest config compilers test

.scheduled_test:
  stage: test
  before_script:
    - *setup-buildtest
  script:
    - buildtest buildspec find --rebuild --root $CI_PROJECT_DIR/buildspecs
    - TESTDIR=$CI_PROJECT_DIR/buildtest/runs/$CI_JOB_NAME/$(date +%F)
    - SCRATCHDIR=$PSCRATCH/buildtest/runs/$CI_JOB_NAME/$(date +%F)
    - |
      if [ -z "$MODE" ]; then
          buildtest build -t $TAGNAME --limit $LIMIT --account m3503_g --timeout $TIMEOUT --testdir $SCRATCHDIR
      else
          buildtest build -t $TAGNAME --limit $LIMIT --account m3503_g --timeout $TIMEOUT --testdir $SCRATCHDIR --executor-type $MODE
      fi
  after_script:
    - *post_run
  artifacts:
    paths:
      - $CI_PROJECT_DIR/.artifacts
    expire_in: 1 week

validate_buildspecs_on_perlmutter:
  extends: .validate_buildspecs
  tags: [perlmutter-bdtest]

validate_buildspecs_on_muller:
  extends: .validate_buildspecs
  tags: [muller-bdtest]

test_compilers_perlmutter:
  extends: .test_compilers
  tags: [ perlmutter-bdtest ]

test_compilers_muller:
  extends: .test_compilers
  tags: [ muller-bdtest ]


.system_check:
  extends: .scheduled_test
  variables:
    TAGNAME: "system"
    CDASH_BUILD_NAME: "system-check"

perlmutter_system_check:
  extends: .system_check
  tags: [perlmutter-bdtest]


muller_system_check:
  extends: .system_check
  tags: [muller-bdtest]

.e4s_test:
  extends: .scheduled_test
  variables:
    TAGNAME: "e4s,e4s-22.11,e4s-23.05"

.e4s_mini_test:
  extends: .e4s_test
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_TYPE == "e4s-mini"
  variables:
    LIMIT: 25
    CDASH_BUILD_NAME: "e4s-mini"

.e4s_large_test:
  extends: .e4s_test
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_TYPE == "large"
  variables:
    LIMIT: 75
    CDASH_BUILD_NAME: "e4s-large"

e4s_mini_test_perlmutter:
  extends: .e4s_mini_test
  tags: [perlmutter-bdtest]

e4s_large_test_perlmutter:
  extends: .e4s_large_test
  tags: [perlmutter-bdtest]

e4s_mini_test_muller:
  extends: .e4s_mini_test
  tags: [muller-bdtest]

e4s_large_test_muller:
  extends: .e4s_large_test
  tags: [muller-bdtest]

.apps_test:
  extends: .scheduled_test
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_TYPE == "apps-mini"
  variables:
    TAGNAME: "compile,gpu,mpi,openmp"
    LIMIT: 25

.apps_mini:
  extends: .apps_test
  variables:
    LIMIT: 25
    CDASH_BUILD_NAME: "apps-mini"

.apps_large:
  extends: .apps_test
  variables:
    LIMIT: 50
    CDASH_BUILD_NAME: "large"

apps_mini_test_perlmutter:
  extends: .apps_mini
  tags: [perlmutter-bdtest]

apps_mini_test_muller:
  extends: .apps_mini
  tags: [muller-bdtest]

.full_testsuite:
  stage: test
  before_script:
    - *setup-buildtest
  script:
    - TESTDIR=$CI_PROJECT_DIR/buildtest/runs/$CI_JOB_NAME/$(date +%F)
    - SCRATCHDIR=$PSCRATCH/buildtest/runs/$CI_JOB_NAME/$(date +%F)
    - buildtest build -b $CI_PROJECT_DIR/buildspecs/ --limit $LIMIT --account m3503_g --timeout $TIMEOUT --testdir $SCRATCHDIR
  after_script:
    - *post_run
  artifacts:
    paths:
      - $CI_PROJECT_DIR/.artifacts
    expire_in: 1 week

.mini_fullsuite:
  extends: .full_testsuite
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_TYPE == "mini-fullsuite"
  variables:
    LIMIT: 25
    CDASH_BUILD_NAME: "mini-fullsuite"


.large_fullsuite:
  extends: .full_testsuite
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_TYPE == "large"
  variables:
    LIMIT: 75
    CDASH_BUILD_NAME: "large-fullsuite"


mini-fullsuite-perlmutter:
  extends: .mini_fullsuite
  tags: [perlmutter-bdtest]

mini-fullsuite-muller:
  extends: .mini_fullsuite
  tags: [muller-bdtest]


large-fullsuite-perlmutter:
  extends: .large_fullsuite
  tags: [perlmutter-bdtest]

large-fullsuite-muller:
  extends: .large_fullsuite
  tags: [muller-bdtest]
